.sast_common: &sast_common
  stage: sast_scan

# ---- ESLINT ----
lint:admin:
  <<: *sast_common
  script:
    - pnpm turbo run lint --filter=admin
  allow_failure: false
  rules:
    - changes:
        - apps/admin/**/*

lint:client:
  <<: *sast_common
  script:
    - pnpm turbo run lint --filter=client
  allow_failure: false
  rules:
    - changes:
        - apps/client/**/*

lint:product-service:
  <<: *sast_common
  script:
    - pnpm turbo run lint --filter=product-service
  allow_failure: false
  rules:
    - changes:
        - apps/product-service/**/*

lint:order-service:
  <<: *sast_common
  script:
    - pnpm turbo run lint --filter=order-service
  allow_failure: false
  rules:
    - changes:
        - apps/order-service/**/*

lint:payment-service:
  <<: *sast_common
  script:
    - pnpm turbo run lint --filter=payment-service
  allow_failure: false
  rules:
    - changes:
        - apps/payment-service/**/*





# # ---- GITLEAKS SCAN ----
# gitleaks_scan:
#   <<: *sast_common
#   image:
#     name: zricethezav/gitleaks:latest
#     entrypoint: [""]
#   script:
#     - gitleaks detect --source . --exit-code 1 --no-banner --redact --report-path gitleaks-report.json
#   artifacts:
#     paths:
#       - gitleaks-report.json
#     when: always
#   allow_failure: false

# # ---- DEPENDENCY AUDIT ----
# npm_audit:
#   <<: *sast_common
#   script:
#     - npm audit --audit-level=moderate
#   allow_failure: false

# dependency_check:
#   <<: *sast_common
#   image:
#     name: owasp/dependency-check:latest
#     entrypoint: [""]
#   cache:
#     key: dependency-check-cache
#     paths:
#       - .dependency-check
#   script:
#     - mkdir -p dependency-check-report
#     - ls
#     - /usr/share/dependency-check/bin/dependency-check.sh --project "my-project" --scan . --exclude "dev" --format "HTML" --out dependency-check-report --failOnCVSS 7 --data .dependency-check
#     - ls -R dependency-check-report
#   artifacts:
#     paths:
#       - dependency-check-report/
#     when: always
#   rules:
#     - if: '$CI_COMMIT_TAG'
#       when: never       # Skip for tags
#     - when: manual      # Show with Play button on commits
#   allow_failure: true    # âœ… Don't block next stage if not run

# # ---- SONARCLOUD ----
# # This job runs the SonarCloud analysis. It requires the `SONAR_TOKEN` variable
# sonarcloud-check:
#   <<: *sast_common
#   image:
#     name: sonarsource/sonar-scanner-cli:latest
#     entrypoint: [""]
#   cache:
#     key: "${CI_JOB_NAME}"
#     paths:
#       - .sonar/cache
#   script:
#     - echo 'sonarqube'
#     - sonar-scanner
#   rules:
#     - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "dev"'
