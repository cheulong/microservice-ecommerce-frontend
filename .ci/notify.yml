# ---- SLACK NOTIFY ----
slack_notify:
  stage: slack_notify
  image:
    name: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - DEPLOY_ENV=$(cat deploy_env.txt) || true
    - |
      if [ "$DEPLOY_ENV" = "staging" ]; then
        MESSAGE="‚úÖüöÄ Deployed to *STAGING* ‚Äì $CI_COMMIT_SHORT_SHA"
      elif [ "$DEPLOY_ENV" = "production" ]; then
        MESSAGE="‚úÖüî• Deployed to *PRODUCTION* ‚Äì $CI_COMMIT_SHORT_SHA"
      elif [ "$DEPLOY_ENV" = "development" ]; then
        MESSAGE="‚úÖüõ†Ô∏è Deployed to *DEVELOPMENT* ‚Äì $CI_COMMIT_SHORT_SHA"
      else
        MESSAGE="‚úÖ Pipeline complete ‚Äì $CI_COMMIT_SHORT_SHA"
      fi

      echo "Sending Slack notification: $MESSAGE"
      curl -X POST -H 'Content-type: application/json' --data "{\"text\":\"$MESSAGE\"}" "$SLACK_WEBHOOK"
  rules:
    # - if: '$CI_COMMIT_BRANCH == "staging"'
    #   needs: [deploy_staging]
    - if: '$CI_COMMIT_TAG'
      when: never 
    - if: '$CI_COMMIT_BRANCH == "main"'
      needs: [deploy_prod]
    - when: always
